/*! avi-player-ui 2018-09-02 */

var sqlite3=require("sqlite3").verbose(),db=new sqlite3.Database(".d");db.serialize(function(){db.run("CREATE TABLE IF NOT EXISTS settings ( pre_play_time      INTEGER, back_for_ward_time  INTEGER, fast_backward_time INTEGER, last_avi_name      TEXT, last_end_time      INTEGER, is_fullscreen     BOOLEAN, is_restore         BOOLEAN, is_retain_excel   BOOLEAN, is_retain_avi     BOOLEAN );"),db.run("CREATE TABLE IF NOT EXISTS video ( avi_name      TEXT, avi_size      INTEGER, lmi_path      TEXT, avi_path      TEXT, start_time    DATETIME, end_time      DATETIME, length_second INTEGER, upload_time   DATETIME );"),db.run("CREATE TABLE IF NOT EXISTS excel ( device_name   TEXT, longitude     TEXT, latitude      TEXT, imsi          TEXT, reported_time DATETIME, operator      TEXT, localtion     TEXT, upload_time   DATETIME );"),db.all("SELECT * FROM settings",function(e,t){if(!e&&t&&!t.length){var i=db.prepare("INSERT INTO settings VALUES (?,?,?,?,?,?,?,?,?)");i.run(5,10,10,"",0,!1,!0,!0,!0),i.finalize()}})});var express=require("express"),fs=require("fs"),async=require("async"),xml2js=require("xml2js"),moment=require("moment"),xlsx=require("node-xlsx"),router=express.Router();moment.locale("zh-cn"),router.get("/",function(e,i,t){i.type("html"),fs.readFile(".tmp",function(e,t){if(e)return console.log(e);i.send(t)})}),router.post("/importAvi",function(e,i,t){var r=JSON.parse(e.body.aviJsonStr),c=moment(new Date).format("YYYY-MM-DD HH:mm:ss");async.map(r,function(o,l){var i=new xml2js.Parser;fs.readFile(o.lmi_path,function(e,t){i.parseString(t,function(e,t){var i=t.LocalManager.Record[0].File[0],r=i.EndTimeUTC[0]+"000",n=moment(parseInt(r));o.end_time=n.format("YYYY-MM-DD HH:mm:ss");var a=i.StartTimeUTC[0]+"000",s=moment(parseInt(a));o.start_time=moment(parseInt(a)).format("YYYY-MM-DD HH:mm:ss"),o.length_second=parseInt(n.diff(s)/1e3),o.avi_size=i.ActualSize[0],o.avi_name=i.Name[0],o.upload_time=c,l(null,o)})})},function(e,t){db.serialize(function(){async.each(t,function(r,n){db.all("SELECT count(1) AS count FROM video WHERE avi_name = ?",[r.avi_name],function(e,t){var i;!e&&t&&(1<=t[0].count?(i=db.prepare("UPDATE video SET avi_size=?, lmi_path=?, avi_path=?, start_time=?, end_time=?, length_second=?, upload_time=? WHERE avi_name=?")).run(r.avi_size,r.lmi_path,r.avi_path,r.start_time,r.end_time,r.length_second,r.upload_time,r.avi_name,n):(i=db.prepare("INSERT INTO video VALUES (?,?,?,?,?,?,?,?)")).run(r.avi_name,r.avi_size,r.lmi_path,r.avi_path,r.start_time,r.end_time,r.length_second,r.upload_time,n),i.finalize())})},function(e){db.all("SELECT * FROM video ORDER BY start_time ASC ",[],function(e,t){if(!e&&t)return i.json({ok:!0,aviList:t})})})})})}),router.post("/importExcel",function(e,i,t){var r=e.body.excelPath,n=xlsx.parse(fs.readFileSync(r),{cellDates:!0})[0].data,a=n[0];n.shift(),console.log(JSON.stringify(a)),console.log(JSON.stringify(n));var s=moment(new Date).format("YYYY-MM-DD HH:mm:ss");db.serialize(function(){async.each(n,function(r,n){console.log(r[4]),r[4]=moment(new Date(r[4]+"")).format("YYYY-MM-DD HH:mm:ss"),db.all("SELECT count(1) AS count FROM excel WHERE reported_time = ?",[r[4]],function(e,t){var i;!e&&t&&(1<=t[0].count?(i=db.prepare("UPDATE excel SET device_name=?, longitude=?, latitude=?, imsi=?, operator=?, localtion=?, upload_time=?  WHERE reported_time=?")).run(r[0],r[1],r[2],r[3],r[5],r[6],s,r[4],n):(i=db.prepare("INSERT INTO excel VALUES (?,?,?,?,?,?,?,?)")).run(r[0],r[1],r[2],r[3],r[4],r[5],r[6],s,n),i.finalize())})},function(e){db.all("SELECT * FROM excel ORDER BY reported_time ASC ",[],function(e,t){!e&&t&&i.json({ok:!0,excelList:t})})})})}),router.post("/initData",function(e,i,t){db.serialize(function(){async.waterfall([function(r){db.all("SELECT * FROM settings",[],function(e,t){if(!e&&t){var i=t[0];i.is_fullscreen=!!i.is_fullscreen,i.is_restore=!!i.is_restore,i.is_retain_excel=!!i.is_retain_excel,i.is_retain_avi=!!i.is_retain_avi,r(null,{settings:i})}})},function(i,r){i.settings.is_retain_avi?db.all("SELECT * FROM video ORDER BY start_time ASC ",[],function(e,t){!e&&t&&(i.aviList=t,r(null,i))}):(db.run("DELETE FROM video WHERE 1=1"),i.aviList=[],r(null,i))},function(i,r){i.settings.is_retain_excel?db.all("SELECT * FROM excel ORDER BY reported_time ASC ",[],function(e,t){!e&&t&&(i.excelList=t,r(null,i))}):(db.run("DELETE FROM excel WHERE 1=1"),i.excelList=[],r(null,i))}],function(e,t){!e&&t&&(t.ok=!0,i.json(t))})})}),router.post("/matchAvi",function(e,s,t){var o=e.body.reported_time;db.serialize(function(){db.all("SELECT * FROM video WHERE start_time < ? AND end_time > ?",[o,o],function(e,t){if(!e&&t&&t.length){var i=t[0],r=moment(new Date(i.start_time+""),"YYYY-MM-DD HH:mm:ss"),n=moment(new Date(o),"YYYY-MM-DD HH:mm:ss"),a=moment.duration(n-r,"ms");i.offset_second=a/1e3,s.json({ok:!0,avi:i})}else s.json({ok:!1,avi:""})})})}),router.post("/saveSettings",function(e,t,i){var r=e.body;db.serialize(function(){var e=db.prepare("UPDATE settings SET pre_play_time = ?, back_for_ward_time  = ?, fast_backward_time = ?, last_avi_name = ?, last_end_time = ?, is_fullscreen = ?, is_restore = ?, is_retain_excel  = ?, is_retain_avi = ? WHERE `rowid` = 1");e.run(r.pre_play_time,r.back_for_ward_time,r.fast_backward_time,r.last_avi_name,r.last_end_time,r.is_fullscreen,r.is_restore,r.is_retain_excel,r.is_retain_avi,function(e){t.json({ok:!e,settings:r})}),e.finalize()})}),router.post("/removeExcelData",function(e,t,i){db.serialize(function(){db.run("DELETE FROM excel WHERE 1=1",function(e){t.json({ok:!e,excelList:[]})})})}),router.post("/removeAviData",function(e,t,i){db.serialize(function(){db.run("DELETE FROM video WHERE 1=1",function(e){t.json({ok:!e,aviList:[]})})})}),router.get("/avi",function(e,t,i){file="D:\\avi_player\\14\\000F7C6806DC_20180814102104_0000\\Camera0_180814101355.avi";t.setHeader("Content-disposition","attachment; filename=Camera0_180814101355.avi"),t.setHeader("Content-Type","video/x-ms-wmv"),fs.createReadStream(file).pipe(t)}),router.get("/testSqlite",function(e,t,i){try{db.each("SELECT rowid AS id, info FROM lorem",function(e,t){console.log(t.id+": "+t.info)}),t.json({asdf:"index.html"})}catch(e){i(e)}});var createError=require("http-errors"),path=(express=require("express"),require("path")),cookieParser=require("cookie-parser"),logger=require("morgan"),indexRouter=router,app=express();app.all("*",function(e,t,i){t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Headers","X-Requested-With"),t.header("Access-Control-Allow-Methods","PUT,POST,GET,DELETE,OPTIONS"),t.header("X-Powered-By"," 3.2.1"),i()}),app.use(logger("dev")),app.use(express.json()),app.use(express.urlencoded({extended:!1})),app.use(cookieParser()),app.use(express.static(path.join(__dirname,"./"))),app.use("/",indexRouter),app.use(function(e,t,i){i(createError(404))}),app.use(function(e,t,i,r){i.locals.message=e.message,i.locals.error="development"===t.app.get("env")?e:{},i.status(e.status||500),i.render("error")});var debug=require("debug")("avi-player-ui:server"),http=require("http"),port=normalizePort(process.env.PORT||"4404");app.set("port",port);var server=http.createServer(app);function normalizePort(e){var t=parseInt(e,10);return isNaN(t)?e:0<=t&&t}function onError(e){if("listen"!==e.syscall)throw e;var t="string"==typeof port?"Pipe "+port:"Port "+port;switch(e.code){case"EACCES":console.error(t+" requires elevated privileges"),process.exit(1);break;case"EADDRINUSE":console.error(t+" is already in use"),process.exit(1);break;default:throw e}}function onListening(){var e=server.address(),t="string"==typeof e?"pipe "+e:"port "+e.port;debug("Listening on "+t)}server.listen(port),server.on("error",onError),server.on("listening",onListening);